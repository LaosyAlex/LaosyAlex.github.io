<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ENSC 105W Quiz Flashcards ‚Äî Study Mode</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* CORE STYLES */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #10b981 0%, #047857 100%); /* Green theme for 105W */
        padding: 40px 20px;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding-bottom: 90px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
        flex: 1 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #065f46 0%, #047857 100%);
      color: white; padding: 40px; text-align: center;
    }
    .header h1 {
      font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .header p { font-size: 1.2em; opacity: 0.9; }
    
    .content { padding: 40px; }

    /* TABLE STYLES (Source of cards) */
    .section { margin-bottom: 50px; }
    .section-title {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white; padding: 15px 25px; border-radius: 10px; margin-bottom: 20px;
      font-size: 1.5em; font-weight: bold; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
    table {
      width: 100%; border-collapse: collapse; margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
    }
    th {
      background: #333; color: white; padding: 18px; text-align: left;
    }
    tr:nth-child(even) { background-color: #f8f9fa; }
    tr:hover { background-color: #ecfdf5; }
    td { padding: 20px; border-bottom: 1px solid #e0e0e0; vertical-align: top; }
    td:first-child { font-weight: 600; color: #064e3b; width: 45%; border-right: 3px solid #10b981; }
    td:last-child { width: 55%; color: #333; }
    
    .question-number {
      display: inline-block; background: #10b981; color: white; padding: 4px 10px;
      border-radius: 5px; font-size: 0.85em; margin-right: 10px; font-weight: bold;
    }
    .blank { border-bottom: 2px solid #10b981; min-width: 50px; display: inline-block; }

    /* STUDY MODE UI */
    .topbar {
      display: flex; gap: 16px; align-items: center; justify-content: space-between;
      background: #ecfdf5; border: 1px solid #d1fae5; color: #064e3b;
      padding: 12px 16px; border-radius: 12px; margin-bottom: 20px;
    }
    .stats { display: flex; gap: 14px; flex-wrap: wrap; font-size: 0.95em; }
    .pill {
      background: #ffffff; border: 1px solid #6ee7b7; color: #065f46;
      padding: 6px 10px; border-radius: 999px; font-weight: 600;
    }
    .controls { display: flex; gap: 10px; align-items: center; }
    .btn {
      appearance: none; border: none; cursor: pointer;
      padding: 10px 14px; border-radius: 10px; font-weight: 700; font-size: 0.95em;
      transition: transform .1s ease, box-shadow .2s ease;
    }
    .btn:active { transform: translateY(2px); }
    .btn-primary { background: #10b981; color: #fff; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .btn-ghost { background: #eef2ff; color: #064e3b; }
    
    /* Rating Buttons */
    .btn-danger { background: #fee2e2; color: #991b1b; }
    .btn-warn { background: #fff7ed; color: #9a3412; }
    .btn-info { background: #e0f2fe; color: #075985; } /* Good */
    .btn-success { background: #dcfce7; color: #065f46; } /* Easy */

    .study-card {
      border: 2px solid #10b98122; border-radius: 16px; padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      margin-bottom: 22px; background: #ffffff; min-height: 200px;
      display: flex; flex-direction: column; justify-content: center;
    }
    .study-q { font-size: 1.3em; color: #064e3b; font-weight: 700; margin-bottom: 20px; }
    .study-a {
      margin-top: 20px; color: #333; background: #f0fdf4; border: 1px dashed #86efac;
      padding: 20px; border-radius: 12px; font-size: 1.1em; display: none;
    }
    
    .rating-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px;
    }

    .qa-table { display: none; } /* Hidden by default in study mode */

    /* CHART & PROGRESS */
    .progress-section {
      background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px;
      padding: 24px; margin-bottom: 24px; display: none;
    }
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px; margin-top: 16px;
    }
    .stat-box {
      background: white; border: 1px solid #cbd5e1; border-radius: 10px;
      padding: 10px; text-align: center;
    }
    .stat-value { font-size: 1.8em; font-weight: 800; color: #059669; }
    .stat-label { font-size: 0.8em; color: #64748b; text-transform: uppercase; }

    /* BOTTOM TOOLBAR */
    .bottom-toolbar {
        position: sticky; bottom: 0; left: 0; right: 0;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
        border-top: 1px solid #e5e7eb; padding: 15px;
        display: flex; gap: 15px; align-items: center; justify-content: center;
        z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }

  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>‚úçÔ∏è ENSC 105W Quiz Flashcards</h1>
      <p>Process, Form, and Convention in Professional Genres</p>
    </div>

    <div class="content">
      
      <div class="topbar" id="topbar">
        <div class="stats">
          <span class="pill" id="stat-due">Due: 0</span>
          <span class="pill" id="stat-new">New: 0</span>
          <span class="pill" id="stat-learning">Learning: 0</span>
        </div>
        <div class="controls">
          <select id="categoryFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #10b981;">
            <option value="all">All Topics</option>
            <option value="style">üìù Style & Grammar</option>
            <option value="visuals">üìä Visuals & Graphs (Tufte)</option>
            <option value="persuasion">üó£Ô∏è Persuasion & Logic</option>
            <option value="process">üß† Process & Cognitive</option>
            <option value="resume">üìÑ Resumes & Cover Letters</option>
          </select>
          <button class="btn btn-ghost" id="btn-reset">Reset</button>
          <button class="btn btn-primary" id="btn-start">Start / Resume</button>
        </div>
      </div>

      <div class="progress-section" id="progressSection">
        <h3 style="margin-bottom:15px; color:#065f46;">Your Progress</h3>
        <div style="height:250px; position:relative;">
            <canvas id="progressChart"></canvas>
        </div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-value" id="stat-mastered">0</div><div class="stat-label">Mastered</div></div>
            <div class="stat-box"><div class="stat-value" id="stat-accuracy">0%</div><div class="stat-label">Accuracy</div></div>
            <div class="stat-box"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Streak</div></div>
        </div>
      </div>

      <div class="study-card" id="studyCard" style="display:none;">
        <div class="study-q" id="studyQ">Question</div>
        <div class="study-a" id="studyA">Answer</div>
        
        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
            <button class="btn btn-primary" id="btn-show" style="width:100%;">Show Answer (Space)</button>
            <span id="info-schedule" style="font-size:0.85em; color:#9ca3af; display:none;"></span>
        </div>

        <div class="rating-bar" id="ratingBar" style="display:none;">
          <button class="btn btn-danger" data-rating="0">Again (1)</button>
          <button class="btn btn-warn" data-rating="1">Hard (2)</button>
          <button class="btn btn-info" data-rating="2">Good (3)</button>
          <button class="btn btn-success" data-rating="3">Easy (4)</button>
        </div>
      </div>

      <div id="allSections" class="qa-table">
        
        <div class="section">
            <div class="section-title">Visuals, Graphs & Tufte</div>
            <table>
                <tbody>
                    <tr><td>How do you calculate the <strong>Data-Ink Ratio</strong>?</td><td>Data Ink / Total Ink used in graphic</td></tr>
                    <tr><td>How do you calculate the <strong>Lie Factor</strong>?</td><td>(Size of effect shown in graphic) / (Size of effect in data)<br><em>Ideally, this should be 1.</em></td></tr>
                    <tr><td>What is <strong>Anscombe's Quartet</strong>?</td><td>Four datasets that have nearly identical simple descriptive statistics (mean, variance, correlation) but have very different distributions and appear very different when plotted. It demonstrates the importance of graphing data.</td></tr>
                    <tr><td>What is the position of <strong>most emphasis</strong> on a page?</td><td>Top Left and Bottom Right (The Z-Pattern).</td></tr>
                    <tr><td>Who created "Napoleon's March to Moscow" (often cited as the best statistical graphic ever)?</td><td>Charles Minard.</td></tr>
                    <tr><td>What does <strong>Chartjunk</strong> refer to?</td><td>Visual elements in charts and graphs that are not necessary to comprehend the information (low data-ink ratio).</td></tr>
                    <tr><td>If a visual length changes from 2 inches to 6 inches, but the data changes from 20 to 40, what is the Lie Factor?</td><td><strong>2</strong><br>Visual change: (6-2)/2 = 200% increase.<br>Data change: (40-20)/20 = 100% increase.<br>Lie Factor = 200/100 = 2.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">Writing Style & Grammar</div>
            <table>
                <tbody>
                    <tr><td>What is a <strong>Nominalization</strong>?</td><td>Turning a verb into a noun (e.g., "make a decision" instead of "decide", "utilization" instead of "use"). It usually weakens the sentence.</td></tr>
                    <tr><td>Define <strong>Empty Openers</strong>.</td><td>Sentences starting with "There is", "There are", "It is". They delay the subject and verb.</td></tr>
                    <tr><td>How many tenses are there in the <strong>Active Voice</strong>?</td><td>12 (Simple, Continuous, Perfect, Perfect Continuous for Past, Present, Future).</td></tr>
                    <tr><td>How many tenses are there in the <strong>Passive Voice</strong>?</td><td>8 (Passive cannot be formed for Future Continuous or any Perfect Continuous tenses).</td></tr>
                    <tr><td>Structure of <strong>Active Voice</strong>?</td><td>Agent &rarr; Action &rarr; Goal (e.g., "Engineers designed the bridge").</td></tr>
                    <tr><td>Structure of <strong>Passive Voice</strong>?</td><td>Goal &rarr; Action &rarr; Agent (e.g., "The bridge was designed by engineers").<br>Formula: <em>To be</em> + Past Participle.</td></tr>
                    <tr><td>Is "I had my hair cut" active or passive?</td><td><strong>Active</strong>. (The subject "I" caused the action).</td></tr>
                    <tr><td>What is a <strong>Noun String</strong>?</td><td>A long sequence of nouns modifying a final noun (e.g., "Worker Hazard Management Inclusion System"). Hard to read.</td></tr>
                    <tr><td>What is the <strong>Royal Order of Adjectives</strong>?</td><td>Observation, Size, Shape, Age, Colour, Origin, Material, Qualifier.<br>(e.g., "Beautiful big old red French wooden sleeping [bag]").</td></tr>
                    <tr><td>What is a <strong>comma splice</strong>?</td><td>Joining two independent clauses with only a comma (incorrect). Needs a conjunction, semi-colon, or period.</td></tr>
                    <tr><td>Which words are <strong>Prepositions</strong>?</td><td>across, before, after, for, in, on, at, of.</td></tr>
                    <tr><td>Which words are <strong>Weak (Talkie) Verbs</strong>?</td><td>to be, to have, to do, to make, to get.</td></tr>
                    <tr><td>"The committee had made the following series of recommendations" contains what style issues?</td><td>Nominalization ("made ... recommendations" vs "recommended") and Weak Verb ("made").</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">Persuasion, Logic & Fallacies</div>
            <table>
                <tbody>
                    <tr><td>What are the three classical appeals (Aristotle)?</td><td><strong>Logos</strong> (Logic/Reason), <strong>Pathos</strong> (Emotion), <strong>Ethos</strong> (Credibility/Ethics).</td></tr>
                    <tr><td>What is the "fourth" appeal added in Technical Writing Essentials?</td><td><strong>Kairos</strong> (Timing/Opportunity).</td></tr>
                    <tr><td>Define <strong>Ad Hominem</strong>.</td><td>Attacking the person rather than the argument.</td></tr>
                    <tr><td>Define <strong>Post Hoc Ergo Propter Hoc</strong>.</td><td>"After this, therefore because of this." False causation based only on sequence (e.g., "I washed my car, so it rained").</td></tr>
                    <tr><td>Define <strong>Begging the Question</strong>.</td><td>Circular reasoning; assuming the conclusion in the premise (e.g., "A is true because B is true, and B is true because A is true").</td></tr>
                    <tr><td>Define <strong>Appeal to Ignorance</strong>.</td><td>Arguing that a claim is true just because it hasn't been proven false (or vice versa).</td></tr>
                    <tr><td>Define <strong>Loaded Presupposition</strong>.</td><td>A question/statement that contains a questionable assumption (e.g., "Do you still beat your dog?").</td></tr>
                    <tr><td>What are the components of the <strong>Toulmin Model</strong>?</td><td>Data, Claim, Warrant, Backing, Qualifier, Rebuttal.</td></tr>
                    <tr><td>In Toulmin's model, what is a <strong>Warrant</strong>?</td><td>The general principle or logic that connects the Data to the Claim.</td></tr>
                    <tr><td>In audience analysis, what does <strong>PANEE</strong> stand for?</td><td>Power, Age, Needs, Expertise, Ethics.</td></tr>
                    <tr><td>In audience analysis, what does <strong>CAMP</strong> stand for?</td><td>Capability (or Control), Attention, Motivation, Perception.</td></tr>
                    <tr><td>What is <strong>Connotation</strong>?</td><td>The emotional or cultural association with a word (e.g., "Cop" vs "Officer").</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">Process, Cognitive & Resumes</div>
            <table>
                <tbody>
                    <tr><td>What is the "Magic Number" for short-term memory (Miller vs. Cowan)?</td><td>Miller: <strong>7 ¬± 2</strong>.<br>Cowan (modern view): <strong>4</strong>.</td></tr>
                    <tr><td>What is <strong>Cognitive Interference</strong>?</td><td>When processing one type of information disrupts the processing of another (e.g., reading text while listening to speech).</td></tr>
                    <tr><td>Bloom's Taxonomy (Revised) - Order from Simple to Complex?</td><td>Remember &rarr; Understand &rarr; Apply &rarr; Analyze &rarr; Evaluate &rarr; Create.</td></tr>
                    <tr><td>In the "Tree" hierarchy, what are the relationships?</td><td><strong>Superordinate</strong> (Parent), <strong>Subordinate</strong> (Child), <strong>Coordinate</strong> (Siblings).</td></tr>
                    <tr><td>What are the 4 stages of the <strong>Creative Process</strong>?</td><td>Preparation (Saturation), Incubation, Illumination, Verification.</td></tr>
                    <tr><td>Resumes: What is the typical section order for a Co-op student?</td><td>1. Education<br>2. Skills<br>3. Projects (Academic/Personal)<br>4. Experience<br>5. Interests.</td></tr>
                    <tr><td>How long do hiring managers typically look at a resume?</td><td>About <strong>10 to 30 seconds</strong>.</td></tr>
                    <tr><td>Experts vs. Novices in Revision: Experts focus on...?</td><td>Global issues: Purpose, Audience, Organization, Content.</td></tr>
                    <tr><td>Experts vs. Novices in Revision: Novices focus on...?</td><td>Local issues: Spelling, Grammar, Punctuation.</td></tr>
                    <tr><td>What does <strong>SIFT</strong> stand for (Source evaluation)?</td><td>Stop, Investigate the source, Find better coverage, Trace claims to original context.</td></tr>
                    <tr><td>What does <strong>WHMIS</strong> stand for?</td><td>Workplace Hazardous Materials Information System.</td></tr>
                </tbody>
            </table>
        </div>

      </div>
    </div>
  </div>

  <div class="bottom-toolbar">
    <label style="display:flex;align-items:center;gap:5px;">
        <input type="checkbox" id="toggleShuffle" checked> Shuffle
    </label>
    <label style="display:flex;align-items:center;gap:5px;">
        <input type="checkbox" id="toggleStudy" checked> Study Mode
    </label>
    <span style="border-left:1px solid #ccc; height:20px; margin:0 10px;"></span>
    <span style="font-size:0.8em; color:#666;">Shortcuts: Space (Show), 1-4 (Rate)</span>
  </div>

  <div class="footer">
    <p>Good luck on the ENSC 105W Quiz! üçÄ</p>
  </div>

  <script>
    /* LOGIC */
    
    // 1. Extraction
    function extractCards() {
      const cards = [];
      const sections = document.querySelectorAll('#allSections .section');
      
      sections.forEach(sec => {
        let cat = 'style'; // default
        const title = sec.querySelector('.section-title').textContent.toLowerCase();
        
        if (title.includes('visual')) cat = 'visuals';
        else if (title.includes('persuasion')) cat = 'persuasion';
        else if (title.includes('process') || title.includes('resumes')) cat = 'process';
        else if (title.includes('style')) cat = 'style';

        const rows = sec.querySelectorAll('tr');
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length >= 2) {
                const q = cells[0].innerHTML;
                const a = cells[1].innerHTML;
                // Generate a consistent ID based on content
                const id = 'card_' + btoa(unescape(encodeURIComponent(q))).slice(0, 16);
                cards.push({ id, q, a, category: cat });
            }
        });
      });
      return cards;
    }

    // 2. State & SRS Logic (Simple SM-2)
    let rawCards = [];
    let state = {}; 
    let queue = [];
    let currentCard = null;
    
    const STORAGE_KEY = 'ensc105_flashcards_v1';
    
    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) return JSON.parse(saved);
        return {};
    }
    
    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        updateChart();
    }

    function init() {
        rawCards = extractCards();
        const savedState = loadState();
        
        // Sync raw cards with state
        rawCards.forEach(c => {
            if (!savedState[c.id]) {
                // New card
                savedState[c.id] = { 
                    id: c.id, 
                    reps: 0, 
                    interval: 0, 
                    ease: 2.5, 
                    dueDate: Date.now() 
                };
            }
        });
        state = savedState;
        
        buildQueue();
        updateStats();
        initChart();
        showNext();
    }

    function buildQueue() {
        const filter = document.getElementById('categoryFilter').value;
        const shuffle = document.getElementById('toggleShuffle').checked;
        const now = Date.now();
        
        // Get all cards that match category
        let eligible = rawCards.filter(c => filter === 'all' || c.category === filter);
        
        // Separate into Due and New (simple approach for this UI)
        // In a real SRS, we'd sort strictly by due date. 
        // Here, we just want to mix them for a session.
        let due = eligible.filter(c => state[c.id].dueDate <= now);
        let future = eligible.filter(c => state[c.id].dueDate > now);
        
        // If shuffle is on, randomize the due cards
        if (shuffle) {
            due.sort(() => Math.random() - 0.5);
        }
        
        queue = due;
        // If we ran out of due cards, maybe pull some new ones? 
        // For cramming purposes, let's allow reviewing "future" cards if queue is empty
        if (queue.length === 0 && future.length > 0) {
           // Sort by soonest due
           future.sort((a,b) => state[a.id].dueDate - state[b.id].dueDate);
           queue = future; // Study ahead
        }
    }

    function showNext() {
        if (queue.length === 0) {
            document.getElementById('studyQ').innerHTML = "üéâ All caught up!";
            document.getElementById('studyA').innerHTML = "You've reviewed all cards for this category.";
            document.getElementById('studyA').style.display = 'block';
            document.getElementById('btn-show').style.display = 'none';
            document.getElementById('ratingBar').style.display = 'none';
            return;
        }

        currentCard = queue[0];
        const s = state[currentCard.id];

        document.getElementById('studyQ').innerHTML = currentCard.q;
        document.getElementById('studyA').innerHTML = currentCard.a;
        document.getElementById('studyA').style.display = 'none';
        document.getElementById('btn-show').style.display = 'block';
        document.getElementById('ratingBar').style.display = 'none';
        
        document.getElementById('info-schedule').textContent = 
            `Reps: ${s.reps} | Interval: ${Math.round(s.interval)}d`;
    }

    function reveal() {
        document.getElementById('studyA').style.display = 'block';
        document.getElementById('btn-show').style.display = 'none';
        document.getElementById('ratingBar').style.display = 'grid';
    }

    function rate(quality) {
        // SM-2 Algorithm Implementation
        if (!currentCard) return;
        
        const s = state[currentCard.id];
        
        // Update stats
        if (quality >= 3) {
            if (s.reps === 0) s.interval = 1;
            else if (s.reps === 1) s.interval = 6;
            else s.interval = Math.round(s.interval * s.ease);
            
            s.reps += 1;
            s.ease = s.ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
        } else {
            s.reps = 0;
            s.interval = 1; // Reset to 1 day (or immediate in this session logic)
            s.ease = s.ease; // Ease doesn't drop drastically in this simplified version
        }
        
        if (s.ease < 1.3) s.ease = 1.3;
        
        // Set new due date (minutes vs days for cramming mode? Let's use days but support immediate "Again")
        // If quality is 0 (Again), make it due in 1 minute.
        // Otherwise use days.
        const now = Date.now();
        if (quality === 0) {
            s.dueDate = now + (60 * 1000); // 1 minute
            // Move to end of queue
            queue.push(queue.shift());
        } else {
            // quality 1, 2, 3 -> push out
            s.dueDate = now + (s.interval * 24 * 60 * 60 * 1000);
            queue.shift(); // Remove from queue
        }
        
        saveState();
        updateStats();
        
        // Session Stats
        sessionReviewed++;
        if(quality > 1) sessionCorrect++;
        if(quality >= 3) sessionStreak++; else sessionStreak = 0;
        updateSessionUI();

        // Next
        showNext();
    }

    /* UI UPDATES */
    let sessionReviewed = 0;
    let sessionCorrect = 0;
    let sessionStreak = 0;
    let chartInstance = null;

    function updateStats() {
        const total = rawCards.length;
        const s = Object.values(state);
        const learned = s.filter(i => i.reps > 2).length;
        const newCards = s.filter(i => i.reps === 0).length;
        const learning = total - learned - newCards;
        const due = queue.length;

        document.getElementById('stat-due').textContent = `Due: ${due}`;
        document.getElementById('stat-new').textContent = `New: ${newCards}`;
        document.getElementById('stat-learning').textContent = `Learning: ${learning}`;
        document.getElementById('stat-mastered').textContent = learned;
    }

    function updateSessionUI() {
        const acc = sessionReviewed === 0 ? 0 : Math.round((sessionCorrect/sessionReviewed)*100);
        document.getElementById('stat-accuracy').textContent = acc + "%";
        document.getElementById('stat-streak').textContent = sessionStreak;
    }

    function initChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['New', 'Learning', 'Mastered'],
                datasets: [{
                    data: [1, 1, 1], // placeholders
                    backgroundColor: ['#d1fae5', '#34d399', '#065f46'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
        updateChart();
    }

    function updateChart() {
        if (!chartInstance) return;
        const s = Object.values(state);
        const learned = s.filter(i => i.reps > 2).length;
        const newC = s.filter(i => i.reps === 0).length;
        const learning = s.length - learned - newC;
        
        chartInstance.data.datasets[0].data = [newC, learning, learned];
        chartInstance.update();
    }

    /* EVENTS */
    document.getElementById('btn-start').addEventListener('click', () => {
        document.getElementById('studyCard').style.display = 'flex';
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('allSections').style.display = 'none';
        window.scrollTo({top: 0, behavior: 'smooth'});
    });
    
    document.getElementById('btn-reset').addEventListener('click', () => {
        if(confirm("Reset progress?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    });

    document.getElementById('toggleStudy').addEventListener('change', (e) => {
        if(e.target.checked) {
            document.getElementById('studyCard').style.display = 'flex';
            document.getElementById('allSections').style.display = 'none';
        } else {
            document.getElementById('studyCard').style.display = 'none';
            document.getElementById('allSections').style.display = 'block';
        }
    });

    document.getElementById('categoryFilter').addEventListener('change', () => {
        buildQueue();
        showNext();
    });

    document.getElementById('btn-show').addEventListener('click', reveal);

    // FIXED BUTTON LISTENER - Using .closest()
    document.getElementById('ratingBar').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-rating]');
        if (btn) {
            const r = parseInt(btn.dataset.rating);
            rate(r);
        }
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('studyCard').style.display === 'none') return;
        
        if (e.code === 'Space') {
            e.preventDefault();
            const btnShow = document.getElementById('btn-show');
            if (btnShow.style.display !== 'none') reveal();
        }
        
        // Only rate if answer is revealed
        if (document.getElementById('studyA').style.display !== 'none') {
            if (e.key === '1') rate(0);
            if (e.key === '2') rate(1);
            if (e.key === '3') rate(2);
            if (e.key === '4') rate(3);
        }
    });

    // Start
    window.addEventListener('load', init);

  </script>
</body>
</html>   